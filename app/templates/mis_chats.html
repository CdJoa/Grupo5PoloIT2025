{% extends "base.html" %}
{% block content %}
<h2>Mis Chats</h2>
<div class="chats-grid">
  {% regroup solicitudes by mascota as chats_por_mascota %}
  {% for grupo in chats_por_mascota %}
    <div class="chat-card">
      <h3>
        {% if grupo.grouper.imagenes.all %}
          <img src="{{ grupo.grouper.imagenes.all.0.imagen.url }}" alt="Foto de {{ grupo.grouper.nombre }}" width="60" style="vertical-align:middle; border-radius:8px; margin-right:8px;">
        {% endif %}
        Mascota: <span>{{ grupo.grouper.nombre }}</span>
      </h3>
      {% for solicitud in grupo.list %}
        <div style="margin-bottom: 0.5em;">
          {% if solicitud.solicitante == user %}
            Con Dueño: <b>{{ solicitud.duenio.username }}</b>
          {% else %}
            Con Solicitante: <b>{{ solicitud.solicitante.username }}</b>
          {% endif %}
          <br>
          Estado:
          {% if solicitud.estado == "pendiente" %}
            <span style="color: orange;">(Esperando confirmación)</span>
            {% if solicitud.duenio == user %}
              <form method="post" action="{% url 'responder_solicitud' solicitud.id %}" style="display:inline;">
                {% csrf_token %}
                <button name="accion" value="aceptar">Aceptar</button>
                <button name="accion" value="rechazar">Rechazar</button>
              </form>
            {% endif %}
          {% elif solicitud.estado == "aceptada" %}
            <a href="{% url 'chat_solicitud' solicitud.id %}">Ir al chat</a>
          {% elif solicitud.estado == "rechazada" %}
            <span style="color: red;">(Solicitud rechazada)</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% empty %}
    <div>No tienes chats activos.</div>
  {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const botonesAceptar = document.querySelectorAll('button[name="accion"][value="aceptar"]');
    const botonesRechazar = document.querySelectorAll('button[name="accion"][value="rechazar"]');

    botonesAceptar.forEach(boton => {
      boton.addEventListener('click', function(event) {
        if (!confirm('¿Estás seguro de que deseas aceptar esta solicitud?')) {
          event.preventDefault();
        }
      });
    });

    botonesRechazar.forEach(boton => {
      boton.addEventListener('click', function(event) {
        if (!confirm('¿Estás seguro de que deseas rechazar esta solicitud?')) {
          event.preventDefault();
        }
      });
    });
  });
</script>
{% endblock %}